{{template "base" .}}

{{define "page-css"}}
<link rel="stylesheet" href="/styles/blogs.css" />
{{end}}

{{define "main"}}
<div class="container">
  <section class="blogs-page">
    <h1 class="blogs-heading">{{t .Lang "sections.blogPosts"}}</h1>
    <p class="blogs-sub">{{t .Lang "sections.blogsDescription"}}</p>

    <!-- Search & Filters -->
    <div class="blog-filters">
      <div class="blog-filters-row">
        <!-- Filter Modal Button -->
        <button type="button" class="filter-modal-btn" data-filter-modal-open>
          <i class="ti ti-filter"></i>
          {{t .Lang "blogs.filter"}}
          {{if or .CurrentCategory .CurrentTag}}<span class="filter-active-dot"></span>{{end}}
        </button>

        <!-- Search -->
        <form action="/blogs" method="GET" class="blog-search">
          {{if .CurrentCategory}}<input type="hidden" name="category" value="{{.CurrentCategory}}" />{{end}}
          {{if .CurrentTag}}<input type="hidden" name="tag" value="{{.CurrentTag}}" />{{end}}
          <i class="ti ti-search search-icon"></i>
          <input type="text" name="search" placeholder="{{t .Lang "blogs.searchPlaceholder"}}" class="search-input" value="{{.CurrentSearch}}" />
        </form>
      </div>
    </div>

    <!-- Filter Modal -->
    <div class="filter-modal" data-filter-modal>
      <div class="filter-modal-backdrop" data-filter-modal-backdrop></div>
      <div class="filter-modal-content">
        <div class="filter-modal-header">
          <h2 class="filter-modal-title">{{t .Lang "blogs.filter"}}</h2>
          <button type="button" class="filter-modal-close" data-filter-modal-close>
            <i class="ti ti-x"></i>
          </button>
        </div>

        <div class="filter-modal-body">
          <!-- Categories Section -->
          <div class="filter-section">
            <h3 class="filter-section-title">{{t .Lang "blogs.categories"}}</h3>
            <div class="filter-pills" data-filter-type="category">
              {{range .BlogCategories}}
              <button type="button" class="filter-pill{{if .Active}} active{{end}}" data-filter-value="{{.Slug}}">
                {{.Name}} <span>{{.Count}}</span>
              </button>
              {{end}}
            </div>
          </div>

          {{if .BlogTags}}
          <!-- Tags Section -->
          <div class="filter-section">
            <h3 class="filter-section-title">{{t .Lang "blogs.tags"}}</h3>
            <div class="filter-pills" data-filter-type="tag">
              {{range .BlogTags}}
              <button type="button" class="filter-pill filter-pill--tag{{if .Active}} active{{end}}" data-filter-value="{{.Slug}}">
                {{.Name}} <span>{{.Count}}</span>
              </button>
              {{end}}
            </div>
          </div>
          {{end}}
        </div>

        <div class="filter-modal-footer">
          <a href="{{.ClearFiltersHref}}" class="clear-filters clear-filters--modal">
            <i class="ti ti-x"></i> {{t .Lang "blogs.clearFilters"}}
          </a>
          <button type="button" class="filter-apply-btn" data-filter-apply>
            {{t .Lang "blogs.apply"}}
          </button>
        </div>
      </div>
    </div>

    <!-- Blog Posts Grid -->
    <div class="blog-grid">
      {{range .Blogs}}
      <article class="blog-card">
        <a href="{{.Slug}}" class="blog-cover">
          <img src="{{.Cover}}" alt="{{.Title}}" loading="lazy" />
        </a>
        <div class="blog-content">
          <div class="blog-meta">
            <span class="blog-category-tag">{{.Category}}</span>
            <time class="blog-date">{{.Date}}</time>
          </div>
          <h2 class="blog-title">
            <a href="{{.Slug}}">{{.Title}}</a>
          </h2>
          <p class="blog-excerpt">{{.Excerpt}}</p>
        </div>
      </article>
      {{end}}
    </div>

    <!-- Pagination -->
    <div class="blog-pagination">
      <a href="{{.PrevPage}}" class="pagination-link pagination-prev {{if not .HasPrev}}disabled{{end}}">
        <i class="ti ti-chevron-left"></i>
        <span class="pagination-label">{{t .Lang "blogs.previous"}}</span>
      </a>
      <div class="pagination-pages">
        {{range .PageNumbers}}
        {{if .IsCurrent}}
        <span class="pagination-number current">{{.Number}}</span>
        {{else if .IsEllipsis}}
        <span class="pagination-ellipsis">...</span>
        {{else}}
        <a href="{{.Href}}" class="pagination-number">{{.Number}}</a>
        {{end}}
        {{end}}
      </div>
      <a href="{{.NextPage}}" class="pagination-link pagination-next {{if not .HasNext}}disabled{{end}}">
        <span class="pagination-label">{{t .Lang "blogs.next"}}</span>
        <i class="ti ti-chevron-right"></i>
      </a>
    </div>
  </section>
</div>
{{end}}

{{define "footer-scripts"}}
<script>
(function() {
  var modal = document.querySelector('[data-filter-modal]');
  var openBtn = document.querySelector('[data-filter-modal-open]');
  var closeBtn = document.querySelector('[data-filter-modal-close]');
  var backdrop = document.querySelector('[data-filter-modal-backdrop]');
  var applyBtn = document.querySelector('[data-filter-apply]');
  var pills = document.querySelectorAll('[data-filter-value]');

  var currentCategory = {{if .CurrentCategory}}"{{.CurrentCategory}}"{{else}}null{{end}};
  var currentTag = {{if .CurrentTag}}"{{.CurrentTag}}"{{else}}null{{end}};
  var currentSearch = {{if .CurrentSearch}}"{{.CurrentSearch}}"{{else}}""{{end}};

  var selectedCategory = currentCategory;
  var selectedTag = currentTag;

  function openModal() {
    if (modal) modal.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    if (modal) modal.classList.remove('open');
    document.body.style.overflow = '';
    resetSelections();
  }

  function resetSelections() {
    selectedCategory = currentCategory;
    selectedTag = currentTag;
    updatePills();
  }

  function updatePills() {
    pills.forEach(function(pill) {
      var value = pill.getAttribute('data-filter-value');
      var type = pill.parentElement.getAttribute('data-filter-type');
      var isActive = false;

      if (type === 'category' && value === selectedCategory) isActive = true;
      if (type === 'tag' && value === selectedTag) isActive = true;

      pill.classList.toggle('active', isActive);
    });
  }

  function applyFilters() {
    var params = new URLSearchParams();
    if (currentSearch) params.set('search', currentSearch);
    if (selectedCategory) params.set('category', selectedCategory);
    if (selectedTag) params.set('tag', selectedTag);

    var queryString = params.toString();
    window.location.href = '/blogs' + (queryString ? '?' + queryString : '');
  }

  if (openBtn) openBtn.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (backdrop) backdrop.addEventListener('click', closeModal);
  if (applyBtn) applyBtn.addEventListener('click', applyFilters);

  pills.forEach(function(pill) {
    pill.addEventListener('click', function() {
      var value = this.getAttribute('data-filter-value');
      var type = this.parentElement.getAttribute('data-filter-type');

      if (type === 'category') {
        selectedCategory = (selectedCategory === value) ? null : value;
      } else if (type === 'tag') {
        selectedTag = (selectedTag === value) ? null : value;
      }

      updatePills();
    });
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
  });
})();
</script>
{{end}}
